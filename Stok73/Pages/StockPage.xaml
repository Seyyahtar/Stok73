<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Stok73.ViewModels"
             xmlns:models="clr-namespace:Stok73.Models"
             x:Class="Stok73.Pages.StockPage"
             x:DataType="viewModels:StockPageViewModel"
             Title="Stok Yönetimi">
    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="SummaryValueStyle" TargetType="Label">
                <Setter Property="FontSize" Value="24" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#0F172A" />
            </Style>

            <Style x:Key="SummaryCaptionStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="#475569" />
            </Style>

            <Style x:Key="HeaderPillStyle" TargetType="Border">
                <Setter Property="HeightRequest" Value="48" />
                <Setter Property="WidthRequest" Value="48" />
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="Stroke" Value="#E2E8F0" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="StrokeShape">
                    <Setter.Value>
                        <Ellipse />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="InlineButtonStyle" TargetType="Button">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="BorderColor" Value="#BFDBFE" />
                <Setter Property="Padding" Value="12,6" />
                <Setter Property="TextColor" Value="#2563EB" />
            </Style>

            <Style x:Key="ActionButtonStyle" TargetType="Button">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="CornerRadius" Value="10" />
                <Setter Property="Padding" Value="10,6" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="BorderColor" Value="#E2E8F0" />
                <Setter Property="TextColor" Value="#2563EB" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*"
          BackgroundColor="#F8FAFC">
        <VerticalStackLayout Grid.Row="0"
                              Padding="24,36,24,12"
                              Spacing="12"
                              BackgroundColor="#F8FAFC">
            <Border BackgroundColor="White"
                    StrokeThickness="0"
                    Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="24" />
                </Border.StrokeShape>
                <Grid ColumnDefinitions="Auto,*,Auto,Auto"
                      ColumnSpacing="12"
                      VerticalOptions="Center">
                    <Border Style="{StaticResource HeaderPillStyle}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateHomeCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="&#x2190;"
                               FontSize="18"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="#0F172A" />
                    </Border>

                    <VerticalStackLayout Grid.Column="1"
                                         VerticalOptions="Center">
                        <Label Text="Stok Paneli"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#0F172A" />
                        <Label Text="Kaynak uygulamasındaki düzen ile uyumlu detaylı görünüm"
                               FontSize="12"
                               TextColor="#475569" />
                    </VerticalStackLayout>

                    <Border Grid.Column="2"
                            Style="{StaticResource HeaderPillStyle}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleMenuCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="&#x2630;"
                               FontSize="18"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="#0F172A" />
                    </Border>

                    <Border Grid.Column="3"
                            Style="{StaticResource HeaderPillStyle}"
                            BackgroundColor="{Binding FilterButtonBackground}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleFilterPanelCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="&#x1F50D;"
                               FontSize="18"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{Binding FilterButtonTextColor}" />
                    </Border>
                </Grid>
            </Border>

            <Border BackgroundColor="White"
                    StrokeThickness="0"
                    Padding="16"
                    IsVisible="{Binding IsFilterPanelVisible}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="24" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    <Entry Placeholder="Stokta ara..."
                           Text="{Binding SearchText}"
                           BackgroundColor="#F1F5F9"
                           TextColor="#0F172A"
                           PlaceholderColor="#94A3B8"
                           HeightRequest="44"
                           Margin="0,0,0,4" />

                    <VerticalStackLayout Spacing="8">
                        <Label Text="Kategori filtreleri"
                               FontAttributes="Bold"
                               TextColor="#0F172A"
                               FontSize="13" />

                        <CollectionView ItemsSource="{Binding Filters}"
                                        SelectionMode="None"
                                        HeightRequest="56">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal"
                                                   ItemSpacing="12" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:FilterOption">
                                    <Border Padding="12,8"
                                            Stroke="{Binding StrokeColor}"
                                            StrokeThickness="1"
                                            BackgroundColor="{Binding BackgroundColor}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="20" />
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleFilterCommand}"
                                                                  CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <HorizontalStackLayout Spacing="8">
                                            <Border WidthRequest="8"
                                                    HeightRequest="8"
                                                    BackgroundColor="{Binding IndicatorColor}"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <Ellipse />
                                                </Border.StrokeShape>
                                            </Border>
                                            <Label Text="{Binding Label}"
                                                   FontSize="13"
                                                   TextColor="{Binding TextColor}" />
                                        </HorizontalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="Tüm filtreleri temizle"
                                Style="{StaticResource InlineButtonStyle}"
                                Command="{Binding ClearFiltersCommand}"
                                IsVisible="{Binding HasActiveFilters}" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <Border BackgroundColor="White"
                    StrokeThickness="0"
                    Padding="12"
                    IsVisible="{Binding IsMenuVisible}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="24" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="8">
                    <Button Text="Stok yönetimi"
                            Command="{Binding OpenStockManagementCommand}"
                            Style="{StaticResource InlineButtonStyle}" />
                    <Button Text="Excel'e aktar"
                            Command="{Binding ExportToExcelCommand}"
                            Style="{StaticResource InlineButtonStyle}" />
                    <Button Text="Excel'den içe aktar"
                            Command="{Binding ImportFromExcelCommand}"
                            Style="{StaticResource InlineButtonStyle}" />
                    <Button Text="Geçmişi görüntüle"
                            Command="{Binding OpenHistoryCommand}"
                            Style="{StaticResource InlineButtonStyle}" />
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="24,0,24,32"
                                 Spacing="20">
                <Grid ColumnDefinitions="*,*,*"
                      ColumnSpacing="16"
                      RowSpacing="12">
                    <Border BackgroundColor="White"
                            StrokeThickness="0"
                            Padding="16">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="24" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding TotalQuantity}"
                                   Style="{StaticResource SummaryValueStyle}" />
                            <Label Text="Toplam adet"
                                   Style="{StaticResource SummaryCaptionStyle}" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Column="1"
                            BackgroundColor="White"
                            StrokeThickness="0"
                            Padding="16">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="24" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding DistinctMaterialCount}"
                                   Style="{StaticResource SummaryValueStyle}" />
                            <Label Text="Kayıtlı kalem"
                                   Style="{StaticResource SummaryCaptionStyle}" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Column="2"
                            BackgroundColor="White"
                            StrokeThickness="0"
                            Padding="16">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="24" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding NextExpiryDisplay}"
                                   Style="{StaticResource SummaryValueStyle}" />
                            <Label Text="En yakın SKT"
                                   Style="{StaticResource SummaryCaptionStyle}" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <VerticalStackLayout Spacing="12">
                    <Label Text="Cihaz grupları"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="#0F172A" />
                    <VerticalStackLayout Spacing="10"
                                         BindableLayout.ItemsSource="{Binding DeviceSummaries}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:DeviceCategorySummary">
                                <Border BackgroundColor="White"
                                        StrokeThickness="0"
                                        Padding="16">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="22" />
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="*,Auto"
                                          ColumnSpacing="16"
                                          VerticalOptions="Center">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title}"
                                                   FontSize="15"
                                                   FontAttributes="Bold"
                                                   TextColor="#0F172A" />
                                            <Label Text="{Binding Description}"
                                                   FontSize="13"
                                                   TextColor="#475569" />
                                        </VerticalStackLayout>
                                        <Border BackgroundColor="{Binding BadgeBackground}"
                                                Padding="16,8"
                                                StrokeThickness="0"
                                                VerticalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="18" />
                                            </Border.StrokeShape>
                                            <Label Text="{Binding Quantity, StringFormat='{0} Adet'}"
                                                   TextColor="{Binding BadgeText}"
                                                   FontAttributes="Bold" />
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="12"
                                     IsVisible="{Binding HasResults}"
                                     BindableLayout.ItemsSource="{Binding VisibleGroups}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:StockGroup">
                            <Border BackgroundColor="White"
                                    StrokeThickness="0"
                                    Padding="20">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="24" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="16">
                                    <Grid ColumnDefinitions="*,Auto"
                                          VerticalOptions="Center">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="#0F172A" />
                                            <Label Text="{Binding TotalQuantity, StringFormat='Toplam {0} adet'}"
                                                   FontSize="13"
                                                   TextColor="#475569" />
                                        </VerticalStackLayout>
                                        <Border WidthRequest="36"
                                                HeightRequest="36"
                                                StrokeThickness="0"
                                                BackgroundColor="#EEF2FF">
                                            <Border.StrokeShape>
                                                <Ellipse />
                                            </Border.StrokeShape>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleGroupCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label Text="&#x25BC;"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   FontSize="12"
                                                   TextColor="#1D4ED8">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                Binding="{Binding IsExpanded}"
                                                                Value="True">
                                                        <Setter Property="Rotation" Value="180" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </Border>
                                    </Grid>

                                    <VerticalStackLayout Spacing="10"
                                                         IsVisible="{Binding IsExpanded}"
                                                         BindableLayout.ItemsSource="{Binding Materials}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:StockMaterialGroup">
                                                <Border BackgroundColor="#F8FAFC"
                                                        StrokeThickness="0"
                                                        Padding="16">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="22" />
                                                    </Border.StrokeShape>
                                                    <VerticalStackLayout Spacing="12">
                                                        <Grid ColumnDefinitions="*,Auto"
                                                              ColumnSpacing="12">
                                                            <Grid.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleMaterialCommand}"
                                                                                    CommandParameter="{Binding .}" />
                                                            </Grid.GestureRecognizers>
                                                            <VerticalStackLayout>
                                                                <Label Text="{Binding FullName}"
                                                                       FontAttributes="Bold"
                                                                       TextColor="#0F172A" />
                                                                <Label Text="{Binding Subtitle}"
                                                                       FontSize="12"
                                                                       TextColor="#64748B" />
                                                            </VerticalStackLayout>
                                                            <Border BackgroundColor="#DBEAFE"
                                                                    Padding="12,6"
                                                                    StrokeThickness="0"
                                                                    VerticalOptions="Center">
                                                                <Border.StrokeShape>
                                                                    <RoundRectangle CornerRadius="18" />
                                                                </Border.StrokeShape>
                                                                <Label Text="{Binding TotalQuantity, StringFormat='{0} Adet'}"
                                                                       FontAttributes="Bold"
                                                                       TextColor="#1D4ED8" />
                                                            </Border>
                                                        </Grid>

                                                        <Border BackgroundColor="White"
                                                                StrokeThickness="0"
                                                                Padding="12"
                                                                IsVisible="{Binding IsExpanded}">
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="18" />
                                                            </Border.StrokeShape>
                                                            <VerticalStackLayout Spacing="12"
                                                                                 BindableLayout.ItemsSource="{Binding Items}">
                                                                <BindableLayout.HeaderTemplate>
                                                                    <DataTemplate>
                                                                        <Grid ColumnDefinitions="2*,*,*,Auto"
                                                                              ColumnSpacing="8"
                                                                              Padding="0,0,0,6">
                                                                            <Label Text="Seri / Lot"
                                                                                   FontAttributes="Bold"
                                                                                   FontSize="12"
                                                                                   TextColor="#475569" />
                                                                            <Label Grid.Column="1"
                                                                                   Text="UBB"
                                                                                   FontAttributes="Bold"
                                                                                   FontSize="12"
                                                                                   TextColor="#475569" />
                                                                            <Label Grid.Column="2"
                                                                                   Text="SKT"
                                                                                   FontAttributes="Bold"
                                                                                   FontSize="12"
                                                                                   TextColor="#475569" />
                                                                            <Label Grid.Column="3"
                                                                                   Text="İşlemler"
                                                                                   FontAttributes="Bold"
                                                                                   FontSize="12"
                                                                                   TextColor="#475569"
                                                                                   HorizontalTextAlignment="End" />
                                                                        </Grid>
                                                                    </DataTemplate>
                                                                </BindableLayout.HeaderTemplate>
                                                                <BindableLayout.ItemTemplate>
                                                                    <DataTemplate x:DataType="models:StockItem">
                                                                        <VerticalStackLayout Spacing="6">
                                                                            <Grid ColumnDefinitions="2*,*,*,Auto"
                                                                                  ColumnSpacing="8">
                                                                                <Label Text="{Binding SerialLotNumber}"
                                                                                       FontSize="13"
                                                                                       TextColor="#0F172A" />
                                                                                <Label Grid.Column="1"
                                                                                       Text="{Binding UbbCode}"
                                                                                       FontSize="13"
                                                                                       TextColor="#0F172A" />
                                                                                <Label Grid.Column="2"
                                                                                       Text="{Binding ExpiryDate, StringFormat='{0:dd.MM.yyyy}'}"
                                                                                       FontSize="13"
                                                                                       TextColor="#0F172A" />
                                                                                <HorizontalStackLayout Grid.Column="3"
                                                                                                      Spacing="4"
                                                                                                      HorizontalOptions="End">
                                                                                    <Border BackgroundColor="#EFF6FF"
                                                                                            Padding="10,4"
                                                                                            StrokeThickness="0">
                                                                                        <Border.StrokeShape>
                                                                                            <RoundRectangle CornerRadius="12" />
                                                                                        </Border.StrokeShape>
                                                                                        <Label Text="{Binding Quantity, StringFormat='{0} Adet'}"
                                                                                               FontSize="12"
                                                                                               TextColor="#1D4ED8" />
                                                                                    </Border>
                                                                                </HorizontalStackLayout>
                                                                            </Grid>
                                                                            <HorizontalStackLayout HorizontalOptions="End"
                                                                                                  Spacing="6">
                                                                                <Button Text="Düzenle"
                                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditItemCommand}"
                                                                                        CommandParameter="{Binding .}"
                                                                                        Style="{StaticResource ActionButtonStyle}" />
                                                                                <Button Text="Stoktan Çıkar"
                                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveItemCommand}"
                                                                                        CommandParameter="{Binding .}"
                                                                                        Style="{StaticResource ActionButtonStyle}" />
                                                                                <Button Text="Sil"
                                                                                        TextColor="#DC2626"
                                                                                        BorderColor="#FECACA"
                                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteItemCommand}"
                                                                                        CommandParameter="{Binding .}"
                                                                                        Style="{StaticResource ActionButtonStyle}" />
                                                                            </HorizontalStackLayout>
                                                                        </VerticalStackLayout>
                                                                    </DataTemplate>
                                                                </BindableLayout.ItemTemplate>
                                                            </VerticalStackLayout>
                                                        </Border>
                                                    </VerticalStackLayout>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <Border BackgroundColor="White"
                        StrokeThickness="0"
                        Padding="24"
                        IsVisible="{Binding IsEmpty}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="24" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="6"
                                         HorizontalOptions="Center">
                        <Label Text="Kayıt bulunamadı"
                               FontAttributes="Bold"
                               TextColor="#0F172A" />
                        <Label Text="Arama ya da filtrelerinizi düzenleyerek tekrar deneyin."
                               FontSize="13"
                               HorizontalTextAlignment="Center"
                               TextColor="#64748B" />
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
