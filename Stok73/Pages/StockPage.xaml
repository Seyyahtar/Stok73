<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Stok73.ViewModels"
             xmlns:models="clr-namespace:Stok73.Models"
             x:Class="Stok73.Pages.StockPage"
             x:DataType="viewModels:StockPageViewModel"
             Title="Stok Yönetimi"
             Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="SummaryValueStyle" TargetType="Label">
                <Setter Property="FontSize" Value="24" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#0F172A" />
            </Style>
            <Style x:Key="SummaryCaptionStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="#475569" />
            </Style>
            <Style x:Key="HeaderPillStyle" TargetType="Border">
                <Setter Property="HeightRequest" Value="44" />
                <Setter Property="WidthRequest" Value="44" />
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="Stroke" Value="#E2E8F0" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="StrokeShape">
                    <Setter.Value>
                        <Ellipse />
                    </Setter.Value>
                </Setter>
            </Style>
            <Style x:Key="InlineButtonStyle" TargetType="Button">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="BorderColor" Value="#E2E8F0" />
                <Setter Property="Padding" Value="14,10" />
                <Setter Property="TextColor" Value="#0F172A" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="ContentLayout" Value="Left,12" />
            </Style>
            <Style x:Key="ActionButtonStyle" TargetType="Button">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="CornerRadius" Value="10" />
                <Setter Property="Padding" Value="10,6" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="BorderColor" Value="#E2E8F0" />
                <Setter Property="TextColor" Value="#2563EB" />
            </Style>
            <Style x:Key="ActionRowBorder" TargetType="Border">
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="12,10" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" BackgroundColor="#F8FAFC">
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="16,24,16,10" Spacing="12">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10" VerticalOptions="Center">
                <Border Style="{StaticResource HeaderPillStyle}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateHomeCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="&#x2190;" FontSize="18" HorizontalOptions="Center" VerticalOptions="Center" TextColor="#0F172A" />
                </Border>
                <Border Grid.Column="1" Style="{StaticResource HeaderPillStyle}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleMenuCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="&#x2261;" FontSize="18" HorizontalOptions="Center" VerticalOptions="Center" TextColor="#0F172A" />
                </Border>
                <Border Grid.Column="2" Style="{StaticResource HeaderPillStyle}" BackgroundColor="{Binding FilterButtonBackground}" StrokeThickness="1" Stroke="{Binding FilterButtonBackground}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleFilterPanelCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="Filtre" FontSize="12" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{Binding FilterButtonTextColor}" />
                </Border>
            </Grid>

            <Border BackgroundColor="White" StrokeThickness="0" Padding="14,10">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" VerticalOptions="Center">
                    <Label Text="&#x1F50D;" FontSize="14" VerticalOptions="Center" TextColor="#94A3B8" />
                    <Entry Grid.Column="1" Placeholder="Stokta ara..." PlaceholderColor="#94A3B8" TextColor="#0F172A" BackgroundColor="Transparent" Text="{Binding SearchText}" />
                </Grid>
            </Border>

            <VerticalStackLayout Spacing="6" IsVisible="{Binding IsFilterPanelVisible}">
                <Label Text="Kategori Filtreleri:" FontAttributes="Bold" FontSize="14" TextColor="#0F172A" />
                <CollectionView ItemsSource="{Binding Filters}" HeightRequest="44">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:FilterOption">
                            <Border Padding="14,6" BackgroundColor="{Binding BackgroundColor}" Stroke="{Binding StrokeColor}" StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleFilterCommand}" CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <Border WidthRequest="8" HeightRequest="8" BackgroundColor="{Binding IndicatorColor}" StrokeThickness="0" VerticalOptions="Center">
                                        <Border.StrokeShape>
                                            <Ellipse />
                                        </Border.StrokeShape>
                                    </Border>
                                    <Label Text="{Binding Label}" FontSize="13" TextColor="{Binding TextColor}" />
                                </HorizontalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <Button Text="Tüm filtreleri temizle" Style="{StaticResource InlineButtonStyle}" Command="{Binding ClearFiltersCommand}" IsVisible="{Binding HasActiveFilters}" />
            </VerticalStackLayout>

            <Border BackgroundColor="White" StrokeThickness="0" Padding="12" IsVisible="{Binding IsMenuVisible}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="6">
                    <Border Style="{StaticResource ActionRowBorder}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OpenStockManagementCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12">
                            <Label Text="+" FontAttributes="Bold" TextColor="#1D4ED8" VerticalOptions="Center" />
                            <Label Text="Stok Yönetimi" FontSize="13" VerticalOptions="Center" TextColor="#0F172A" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border Style="{StaticResource ActionRowBorder}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ExportToExcelCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12">
                            <Label Text="⇩" FontAttributes="Bold" TextColor="#1D4ED8" VerticalOptions="Center" />
                            <Label Text="Excel ile Dışarı Aktar" FontSize="13" VerticalOptions="Center" TextColor="#0F172A" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border Style="{StaticResource ActionRowBorder}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ImportFromExcelCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12">
                            <Label Text="⇧" FontAttributes="Bold" TextColor="#1D4ED8" VerticalOptions="Center" />
                            <Label Text="Excel ile İçe Aktar" FontSize="13" VerticalOptions="Center" TextColor="#0F172A" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border Style="{StaticResource ActionRowBorder}">
                        <HorizontalStackLayout Spacing="12">
                            <Label Text="⟳" FontAttributes="Bold" TextColor="#1D4ED8" VerticalOptions="Center" />
                            <Label Text="Geçmiş" FontSize="13" VerticalOptions="Center" TextColor="#0F172A" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>

        <!-- Body -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="24,0,24,32" Spacing="20">
                <VerticalStackLayout Spacing="10" BackgroundColor="White" Padding="14">
                    <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                        <Label Text="Cihaz Adetleri" FontSize="14" FontAttributes="Bold" TextColor="#0F172A" />
                        <Label Grid.Column="2" Text="&#x25BE;" FontSize="14" TextColor="#94A3B8" VerticalOptions="Center" />
                    </Grid>
                    <FlexLayout Wrap="Wrap" JustifyContent="Start" AlignItems="Start" BindableLayout.ItemsSource="{Binding DeviceSummaries}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:DeviceCategorySummary">
                                <Border BackgroundColor="{Binding BadgeBackground}" StrokeThickness="0" Padding="12,8" Margin="0,0,8,8">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="14" />
                                    </Border.StrokeShape>
                                    <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                        <Label Text="{Binding Title}" FontAttributes="Bold" TextColor="{Binding BadgeText}" />
                                        <Label Text="{Binding Quantity, StringFormat='{0} Adet'}" FontSize="12" TextColor="{Binding BadgeText}" />
                                    </HorizontalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </VerticalStackLayout>

                <HorizontalStackLayout Spacing="8" Padding="0,0,0,6">
                    <Label Text="Malzeme Kayıtları:" FontSize="13" TextColor="#475569" />
                    <Label Text="{Binding DistinctMaterialCount}" FontSize="13" TextDecorations="Underline" TextColor="#1D4ED8" />
                    <Label Text="|" FontSize="13" TextColor="#94A3B8" />
                    <Label Text="Toplam Adet:" FontSize="13" TextColor="#475569" />
                    <Label Text="{Binding TotalQuantity}" FontSize="13" TextDecorations="Underline" TextColor="#1D4ED8" />
                </HorizontalStackLayout>

                <VerticalStackLayout Spacing="12" IsVisible="{Binding HasResults}" BindableLayout.ItemsSource="{Binding VisibleGroups}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:StockGroup">
                            <Border BackgroundColor="#EEF2FF" StrokeThickness="0" Padding="18">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="18" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="16">
                                    <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                                        <Label Text="+" FontSize="16" FontAttributes="Bold" VerticalOptions="Center">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="True">
                                                    <Setter Property="Text" Value="-" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title}" FontSize="18" FontAttributes="Bold" TextColor="#0F172A" />
                                            <Label Text="{Binding TotalQuantity, StringFormat='Toplam {0} adet'}" FontSize="13" TextColor="#475569" />
                                        </VerticalStackLayout>
                                        <Border Grid.Column="2" WidthRequest="32" HeightRequest="32" StrokeThickness="0" BackgroundColor="White">
                                            <Border.StrokeShape>
                                                <Ellipse />
                                            </Border.StrokeShape>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleGroupCommand}" CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label Text="&#x25BC;" HorizontalOptions="Center" VerticalOptions="Center" FontSize="12" TextColor="#1D4ED8">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="True">
                                                        <Setter Property="Rotation" Value="180" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </Border>
                                    </Grid>

                                    <VerticalStackLayout Spacing="10" IsVisible="{Binding IsExpanded}" BindableLayout.ItemsSource="{Binding Materials}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:StockMaterialGroup">
                                                <Border BackgroundColor="White" StrokeThickness="1" Stroke="#E2E8F0" Padding="14">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="14" />
                                                    </Border.StrokeShape>
                                                    <VerticalStackLayout Spacing="12">
                                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                                            <Grid.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleMaterialCommand}" CommandParameter="{Binding .}" />
                                                            </Grid.GestureRecognizers>
                                                            <Label Text="+" FontSize="16" FontAttributes="Bold" VerticalOptions="Center">
                                                                <Label.Triggers>
                                                                    <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="True">
                                                                        <Setter Property="Text" Value="-" />
                                                                    </DataTrigger>
                                                                </Label.Triggers>
                                                            </Label>
                                                            <VerticalStackLayout>
                                                                <Label Text="{Binding FullName}" FontAttributes="Bold" TextColor="#0F172A" />
                                                                <Label Text="{Binding TotalQuantity, StringFormat='{0} Adet'}" FontSize="12" TextColor="#475569" />
                                                            </VerticalStackLayout>
                                                            <Border Grid.Column="2" WidthRequest="32" HeightRequest="32" StrokeThickness="0" BackgroundColor="#EEF2FF">
                                                                <Border.StrokeShape>
                                                                    <Ellipse />
                                                                </Border.StrokeShape>
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleMaterialCommand}" CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <Label Text="&#x25BC;" HorizontalOptions="Center" VerticalOptions="Center" FontSize="12" TextColor="#1D4ED8">
                                                                    <Label.Triggers>
                                                                        <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="True">
                                                                            <Setter Property="Rotation" Value="180" />
                                                                        </DataTrigger>
                                                                    </Label.Triggers>
                                                                </Label>
                                                            </Border>
                                                        </Grid>

                                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding IsExpanded}">
                                                            <Grid ColumnDefinitions="2*,*,*,Auto" ColumnSpacing="8" Padding="0,0,0,6">
                                                                <Label Text="Seri/Lot" FontAttributes="Bold" FontSize="12" TextColor="#475569" />
                                                                <Label Grid.Column="1" Text="UBB" FontAttributes="Bold" FontSize="12" TextColor="#475569" />
                                                                <Label Grid.Column="2" Text="SKT" FontAttributes="Bold" FontSize="12" TextColor="#475569" />
                                                                <Label Grid.Column="3" Text="İşlemler" FontAttributes="Bold" FontSize="12" TextColor="#475569" HorizontalTextAlignment="End" />
                                                            </Grid>

                                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Items}" Spacing="8">
                                                                <BindableLayout.ItemTemplate>
                                                                    <DataTemplate x:DataType="models:StockItem">
                                                                        <VerticalStackLayout Spacing="6">
                                                                            <Grid ColumnDefinitions="2*,*,*,Auto" ColumnSpacing="8">
                                                                                <Label Text="{Binding SerialLotNumber}" FontSize="13" TextColor="#0F172A" />
                                                                                <Label Grid.Column="1" Text="{Binding UbbCode}" FontSize="13" TextColor="#0F172A" />
                                                                                <Label Grid.Column="2" Text="{Binding ExpiryDate, StringFormat='{0:dd.MM.yyyy}'}" FontSize="13" TextColor="#0F172A" />
                                                                                <HorizontalStackLayout Grid.Column="3" Spacing="4" HorizontalOptions="End">
                                                                                    <Border BackgroundColor="#EFF6FF" Padding="10,4" StrokeThickness="0">
                                                                                        <Border.StrokeShape>
                                                                                            <RoundRectangle CornerRadius="12" />
                                                                                        </Border.StrokeShape>
                                                                                        <Label Text="{Binding Quantity, StringFormat='{0} Adet'}" FontSize="12" TextColor="#1D4ED8" />
                                                                                    </Border>
                                                                                </HorizontalStackLayout>
                                                                            </Grid>
                                                                            <HorizontalStackLayout HorizontalOptions="End" Spacing="6">
                                                                                <Button Text="Düzenle" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditItemCommand}" CommandParameter="{Binding .}" Style="{StaticResource ActionButtonStyle}" />
                                                                                <Button Text="Stoktan Çıkar" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveItemCommand}" CommandParameter="{Binding .}" Style="{StaticResource ActionButtonStyle}" />
                                                                                <Button Text="Sil" TextColor="#DC2626" BorderColor="#FECACA" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteItemCommand}" CommandParameter="{Binding .}" Style="{StaticResource ActionButtonStyle}" />
                                                                            </HorizontalStackLayout>
                                                                        </VerticalStackLayout>
                                                                    </DataTemplate>
                                                                </BindableLayout.ItemTemplate>
                                                            </VerticalStackLayout>
                                                        </VerticalStackLayout>
                                                    </VerticalStackLayout>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <Border BackgroundColor="White" StrokeThickness="0" Padding="24" IsVisible="{Binding IsEmpty}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="24" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="6" HorizontalOptions="Center">
                        <Label Text="Kayıt bulunamadı" FontAttributes="Bold" TextColor="#0F172A" />
                        <Label Text="Arama ya da filtrelerinizi düzenleyerek tekrar deneyin." FontSize="13" HorizontalTextAlignment="Center" TextColor="#64748B" />
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
